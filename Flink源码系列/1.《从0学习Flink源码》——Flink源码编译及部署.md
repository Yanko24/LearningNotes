### ã€Šä»0å­¦ä¹ Flinkæºç ã€‹â€”â€”Flinkæºç ç¼–è¯‘åŠéƒ¨ç½²

#### 1. å‰è¨€

é’ˆå¯¹Flinkçš„æºç è¿›è¡Œä¸€ä¸ªåˆæ­¥äº†è§£ï¼Œå­¦ä¹ Flinkæ¡†æ¶ä¸­ä¼˜ç§€çš„è®¾è®¡åŒæ—¶ä¹Ÿå¯ä»¥é’ˆå¯¹å¹³æ—¶æ‰€å‡ºç°çš„é—®é¢˜æœ‰ä¸€ä¸ªç³»ç»Ÿçš„è®¤è¯†ã€‚ä»Šå¤©å¼€å§‹ä»0å­¦ä¹ Flinkæºç ï¼Œæœ¬ç³»åˆ—ç”¨æ¥è®°å½•åœ¨Flinkæºç å­¦ä¹ è¿‡ç¨‹ä¸­é‡è§çš„ä¸€äº›é—®é¢˜ã€‚

#### 2. ä¸‹è½½æºç å¹¶ç¼–è¯‘

ç¡®ä¿å®‰è£…äº†javaç¯å¢ƒå’Œmavenç¯å¢ƒ

```shell
$ java -version
$ mvn -version
$ wget https://dlcdn.apache.org/flink/flink-1.13.6/flink-1.13.6-src.tgz
$ tar -zvxf flink-1.13.6-src.tgz
$ cd flink-1.13.6
$ mvn clean install -DskipTests
```

ç¼–è¯‘è¿‡ç¨‹ä¸­å¯èƒ½å› ä¸ºç½‘ç»œç­‰åŸå› å¯¼è‡´ç¼–è¯‘ä¸æˆåŠŸï¼Œå¯ä»¥è®¾ç½®mavençš„é…ç½®æ–‡ä»¶`setting.xml`ä¸­çš„mirrorsï¼š

```xml
<mirror>
    <id>nexus aliyun</id>
    <name>Nexus-Aliyun</name>
    <url>https://maven.aliyun.com/repository/public</url>
    <mirrorOf>*,!jeecg,!jeecg-snapshots,!mapr-releases,!confluent,!spring</mirrorOf>
</mirror>
<mirror>
    <id>mapr-public</id>
    <name>mapr-releases</name>
    <url>https://maven.aliyun.com/repository/mapr-public</url>
    <mirrorOf>mapr-releases</mirrorOf>
</mirror>
<mirror>
    <id>confluent-repo</id>
    <name>confluent-repo</name>
    <url>http://packages.confluent.io/maven</url>
    <mirrorOf>confluent</mirrorOf>
</mirror>
<mirror>
    <id>aliyun maven</id>
    <name>spring-plugin</name>
    <url>https://maven.aliyun.com/repository/spring-plugin</url>
    <mirrorOf>spring</mirrorOf>
</mirror>
```

åœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­å¯èƒ½å‡ºç°`flink-runtime-web`æ¨¡å—ç¼–è¯‘æŠ¥é”™ï¼Œå¦‚ä¸‹ï¼š

![](images/ç¼–è¯‘flink-runtime-web.png)

è¿›å…¥`flink-runtime-web/web-dashboard`ç›®å½•ä¸‹ï¼Œåˆ é™¤`node_modules`ç›®å½•ï¼Œæ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š

```shell
$ cd flink-runtime-web/web-dashboard
$ rm -rf ./node_modules

# è®°å¾—è®¾ç½®è‡ªå·±æœ¬åœ°çš„npmæºä¸ºæ·˜å®é•œåƒï¼Œä¼šæ¯”è¾ƒå¿«
$ npm config set registry npm config set registry http://registry.npm.taobao.org/
$ npm update

# æ›´æ–°å®Œæˆä¹‹åæ‰§è¡Œnpm install
$ npm install

# æ‰§è¡Œnpm run buildæµ‹è¯•
$ npm run build
```

ç»§ç»­æŠ¥é”™ï¼š

![](images/npmå®‰è£…æŠ¥é”™.png)

æŠ¥é”™æ˜¾ç¤ºæ‰¾ä¸åˆ°åŒ…`@ant-design/icons-angular/icons`ï¼Œæ‰‹åŠ¨å®‰è£…ï¼š

```shell
$ npm install -g @ant-design/icons-angular

# å®‰è£…æŠ¥é”™å…ˆå®‰è£…@angular/cli
$ npm install -g @angular/cli

# æ¢ä¸ªæ–¹å¼å®‰è£…@ant-design/icons-angular/icons
$ ng add @ant-design/icons-angular

# å…ˆåœ¨æœ¬åœ°è¿›è¡Œbuildå°è¯•ï¼Œå¦‚ä¸‹æ‰€ç¤ºå°±å¯ä»¥ç»§ç»­è¿›è¡Œæ‰“åŒ…äº†
$ npm run build
```

å¦‚æœæ‰“åŒ…è¿˜æŠ¥é”™å¦‚ä¸‹ï¼š

![](images/web-build.png)

å¯ä»¥æ‰‹åŠ¨å®‰è£…node-gypåŒ…ï¼š

```shell
$ npm i node-gyp -g
```

æ‰§è¡Œmavenæ‰“åŒ…å‘½ä»¤ï¼š

```shell
$ mvn clean install -DskipTests
```

ä¹Ÿå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è·³è¿‡æµ‹è¯•ã€ä»£ç é£æ ¼ä»¥åŠLicenseæ£€æŸ¥ï¼š

```shell
mvn clean install -Dmaven.test.skip=true -Dmaven.javadoc.skip=true -Dcheckstyle.skip=true -Drat.skip=true
```

å‡ºç°å¦‚ä¸‹å›¾æ‰€ç¤ºçš„å…¨ç¯‡ç»¿è‰²å°±è¯´æ˜ç¼–è¯‘æˆåŠŸäº†ğŸ˜

![](images/flink-1.13.6-complier.jpg)

#### 3. åœ¨æœ¬åœ°å¯åŠ¨æµ‹è¯•

```shell
$ cd flink-dist/target/flink-1.13.6-bin/flink-1.13.6
$ ./bin/start-cluster.sh

# ä¿®æ”¹taskManagerçš„slotæ•°é‡
$ vi ./conf/flink-conf.yaml
```

![](images/flink-1.13.6-webui.png)

#### 4. ç®€å•ç¨‹åºWordCountæµ‹è¯•

```java
@Data
@NoArgsConstructor
@AllArgsConstructor
class WordCount {
    private String word;
    private Integer count;
}

public class SocketWindowWordCount {
    private static final Logger LOG = LoggerFactory.getLogger(SocketWindowWordCount.class);

    public static void main(String[] args) {
        try {
            // è¾“å‡ºå‚æ•°hostå’Œport
            final String host;
            final int port;

            ParameterTool params = ParameterTool.fromArgs(args);
            host = params.get("host");
            port = params.getInt("port");
            // åˆ›å»ºenvå¹¶é…ç½®
            StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();
            // ä»socketä¸­è·å–æ•°æ®
            DataStreamSource<String> socketDS = env.socketTextStream(host, port, "\n");
            // å¤„ç†æ•°æ®
            SingleOutputStreamOperator<WordCount> reduceDS =
                    socketDS.flatMap(
                                    new FlatMapFunction<String, WordCount>() {
                                        @Override
                                        public void flatMap(String value, Collector<WordCount> out)
                                                throws Exception {
                                            String[] words = value.split(",");
                                            for (String word : words) {
                                                out.collect(new WordCount(word, 1));
                                            }
                                        }
                                    })
                            .keyBy(WordCount::getWord)
                            .window(
                                    SlidingProcessingTimeWindows.of(
                                            Time.seconds(5), Time.seconds(2)))
                            .reduce(
                                    new ReduceFunction<WordCount>() {
                                        @Override
                                        public WordCount reduce(WordCount value1, WordCount value2)
                                                throws Exception {
                                            return new WordCount(
                                                    value1.getWord(),
                                                    value1.getCount() + value1.getCount());
                                        }
                                    })
                            .disableChaining();

            // æ‰“å°è¾“å‡º
            reduceDS.print().setParallelism(1);

            // æäº¤æ‰§è¡Œ
            env.execute("Socket Window WordCount");
        } catch (Exception e) {
            System.out.println("Encounter Errorï¼š");
            LOG.error("Encounter Errorï¼š", e);
            System.exit(1);
        }
    }
}
```

æ‰“åŒ…ï¼Œæ„å»ºjaråŒ…ï¼š

```shell
$ mvn clean package
$ ls target/flink-learning-demo-1.0-SNAPSHOT.jar
```

å¼€å¯9999ç«¯å£ï¼Œç”¨äºè¾“å…¥æ•°æ®ï¼š

```shell
$ nc -lk 9999
```

æäº¤flinkä»»åŠ¡ï¼š

```shell
$ bin/flink run --detached -c com.yankee.wordcount.SocketWindowWordCount /Users/yankee/demojar/flink-learning-demo-1.0-SNAPSHOT.jar --host localhost --port 9999
```

æäº¤åå¯ä»¥åœ¨WebUIæŸ¥çœ‹è¿è¡Œæƒ…å†µä»¥åŠlogæ—¥å¿—ï¼ŒåŒæ—¶flink1.13ç‰ˆæœ¬å¼€å¯äº†CPUçš„ç«ç„°å›¾ï¼Œé»˜è®¤å…³é—­ã€‚å¯ä»¥è®¾ç½®ä»¥ä¸‹å‚æ•°å¼€å¯ï¼Œå…·ä½“å¯å‚è€ƒ[å®˜ç½‘](https://nightlies.apache.org/flink/flink-docs-release-1.13/docs/deployment/config/#rest-flamegraph-enabled)ã€‚

```yaml
rest.flamegraph.enabled: true
```